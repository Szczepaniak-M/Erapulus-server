<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">
    <changeSet author="Szczepaniak-M" id="202108141232">
        <comment>Initialize tables</comment>
        <createTable tableName="University">
            <column autoIncrement="true" name="id" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="NVARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="address" type="NVARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="address2" type="NVARCHAR(255)">
                <constraints nullable="true"/>
            </column>
            <column name="zipcode" type="VARCHAR(31)">
                <constraints nullable="false"/>
            </column>
            <column name="city" type="NVARCHAR(63)">
                <constraints nullable="false"/>
            </column>
            <column name="country" type="NVARCHAR(63)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="NVARCHAR(MAX)">
                <constraints nullable="true"/>
            </column>
            <column name="lastModifiedBy" type="INT">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <createTable tableName="Document">
            <column name="id" autoIncrement="true" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="NVARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="description" type="NVARCHAR(MAX)">
                <constraints nullable="true"/>
            </column>
            <column name="path" type="VARCHAR(63)">
                <constraints nullable="false"/>
            </column>
            <column name="university" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="lastModifiedBy" type="INT">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <createTable tableName="ApplicationUser">
            <column name="id" autoIncrement="true" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="type" type="VARCHAR(15)">
                <constraints nullable="false"/>
            </column>
            <column name="firstName" type="NVARCHAR(31)">
                <constraints nullable="false"/>
            </column>
            <column name="lastName" type="NVARCHAR(31)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="VARCHAR(63)">
                <constraints nullable="false"/>
            </column>
            <column name="password" type="VARCHAR(255)">
                <constraints nullable="true"/>
            </column>
            <column name="facebookUrl" type="VARCHAR(63)">
                <constraints nullable="true"/>
            </column>
            <column name="whatsUpUrl" type="VARCHAR(63)">
                <constraints nullable="true"/>
            </column>
            <column name="instagramUsername" type="VARCHAR(63)">
                <constraints nullable="true"/>
            </column>
            <column name="university" type="int">
                <constraints nullable="true"/>
            </column>
            <column name="lastModifiedBy" type="INT">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <createTable tableName="Friend">
            <column name="id" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="applicationUser" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="friend" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="status" type="VARCHAR(15)">
                <constraints nullable="false"/>
            </column>
            <column name="lastModifiedBy" type="INT">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <createTable tableName="Device">
            <column name="id" autoIncrement="true" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="applicationUser" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="deviceId" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="lastModifiedBy" type="INT">
                <constraints nullable="true"/>
            </column>
        </createTable>
        <createTable tableName="Role">
            <column name="id" autoIncrement="true" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="name" type="VARCHAR(31)">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <createTable tableName="ApplicationUserRole">
            <column name="id" autoIncrement="true" type="INT">
                <constraints primaryKey="true"/>
            </column>
            <column name="applicationUser" type="int">
                <constraints nullable="false"/>
            </column>
            <column name="role" type="int">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <!-- FK Constraints-->
        <addForeignKeyConstraint baseTableName="Document" baseColumnNames="university"
                                 constraintName="FK_Document_university_University"
                                 referencedTableName="University" referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <addForeignKeyConstraint baseTableName="ApplicationUser" baseColumnNames="university"
                                 constraintName="FK_ApplicationUser_university_University"
                                 referencedTableName="University" referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <addForeignKeyConstraint baseTableName="Device" baseColumnNames="applicationUser"
                                 constraintName="FK_Device_university_ApplicationUser"
                                 referencedTableName="ApplicationUser" referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <addForeignKeyConstraint baseTableName="Friend" baseColumnNames="applicationUser"
                                 constraintName="FK_Friend_user_ApplicationUser"
                                 referencedTableName="ApplicationUser" referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <addForeignKeyConstraint baseTableName="Friend" baseColumnNames="friend"
                                 constraintName="FK_Friend_friend_ApplicationUser"
                                 referencedTableName="ApplicationUser" referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <addForeignKeyConstraint baseTableName="ApplicationUserRole" baseColumnNames="applicationUser"
                                 constraintName="FK_ApplicationUserRole_user_ApplicationUser"
                                 referencedTableName="ApplicationUser" referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <addForeignKeyConstraint baseTableName="ApplicationUserRole" baseColumnNames="role"
                                 constraintName="FK_ApplicationUserRole_role_Role"
                                 referencedTableName="Role" referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>

        <!-- Unique Constraints -->
        <addUniqueConstraint tableName="Friend" columnNames="applicationUser, friend"
                             constraintName="UQ_Friend_applicationUser_friend"/>
        <addUniqueConstraint tableName="ApplicationUserRole" columnNames="applicationUser, role"
                             constraintName="UQ_ApplicationUserRole_applicationUser_role"/>
        <addUniqueConstraint tableName="ApplicationUser" columnNames="email"
                             constraintName="UQ_ApplicationUser_email"/>

        <!-- lastModifiedBy Constraints -->
        <addForeignKeyConstraint baseTableName="University" baseColumnNames="lastModifiedBy"
                                 constraintName="FK_University_lastModifiedBy_ApplicationUser"
                                 referencedTableName="ApplicationUser" referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <addForeignKeyConstraint baseTableName="Document" baseColumnNames="lastModifiedBy"
                                 constraintName="FK_Document_lastModifiedBy_ApplicationUser"
                                 referencedTableName="ApplicationUser" referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <addForeignKeyConstraint baseTableName="ApplicationUser" baseColumnNames="lastModifiedBy"
                                 constraintName="FK_ApplicationUser_lastModifiedBy_ApplicationUser"
                                 referencedTableName="ApplicationUser" referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <addForeignKeyConstraint baseTableName="Device" baseColumnNames="lastModifiedBy"
                                 constraintName="FK_Device_lastModifiedBy_ApplicationUser"
                                 referencedTableName="ApplicationUser" referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <addForeignKeyConstraint baseTableName="Friend" baseColumnNames="lastModifiedBy"
                                 constraintName="FK_Friend_lastModifiedBy_ApplicationUser"
                                 referencedTableName="ApplicationUser" referencedColumnNames="id"
                                 onDelete="RESTRICT" onUpdate="RESTRICT"/>
        <rollback>
            <dropTable tableName="UserRole"/>
            <dropTable tableName="Role"/>
            <dropTable tableName="Device"/>
            <dropTable tableName="Friend"/>
            <dropTable tableName="Document"/>
            <dropTable tableName="ApplicationUser"/>
            <dropTable tableName="University"/>
        </rollback>
    </changeSet>
    <changeSet id="202108141328" author="Szczepaniak-M" dbms="mssql">
        <comment>Adding history tables</comment>
        <createTable tableName="UniversityHistory">
            <column name="historyId" type="INT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="operation" type="VARCHAR(7)">
                <constraints nullable="false"/>
            </column>
            <column name="operationTime" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="INT"/>
            <column name="name" type="NVARCHAR(255)"/>
            <column name="address" type="NVARCHAR(255)"/>
            <column name="address2" type="NVARCHAR(255)"/>
            <column name="zipcode" type="VARCHAR(31)"/>
            <column name="city" type="NVARCHAR(63)"/>
            <column name="country" type="NVARCHAR(63)"/>
            <column name="description" type="NVARCHAR(MAX)"/>
            <column name="lastModifiedBy" type="INT"/>
        </createTable>
        <createTable tableName="DocumentHistory">
            <column name="historyId" type="INT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="operation" type="VARCHAR(7)">
                <constraints nullable="false"/>
            </column>
            <column name="operationTime" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="INT"/>
            <column name="name" type="NVARCHAR(255)"/>
            <column name="description" type="NVARCHAR(MAX)"/>
            <column name="path" type="VARCHAR(64)"/>
            <column name="university" type="INT"/>
            <column name="lastModifiedBy" type="INT"/>
        </createTable>
        <createTable tableName="ApplicationUserHistory">
            <column name="historyId" type="INT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="operation" type="VARCHAR(7)">
                <constraints nullable="false"/>
            </column>
            <column name="operationTime" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="INT"/>
            <column name="type" type="VARCHAR(15)"/>
            <column name="firstName" type="NVARCHAR(31)"/>
            <column name="lastName" type="NVARCHAR(31)"/>
            <column name="email" type="VARCHAR(63)"/>
            <column name="password" type="VARCHAR(255)"/>
            <column name="facebookUrl" type="VARCHAR(63)"/>
            <column name="whatsUpUrl" type="VARCHAR(63)"/>
            <column name="instagramUsername" type="VARCHAR(63)"/>
            <column name="university" type="int"/>
            <column name="lastModifiedBy" type="INT"/>
        </createTable>
        <createTable tableName="FriendHistory">
            <column name="historyId" type="INT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="operation" type="VARCHAR(7)">
                <constraints nullable="false"/>
            </column>
            <column name="operationTime" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="INT"/>
            <column name="applicationUser" type="INT"/>
            <column name="friend" type="INT"/>
            <column name="status" type="VARCHAR(15)"/>
            <column name="lastModifiedBy" type="INT"/>
        </createTable>
        <createTable tableName="DeviceHistory">
            <column name="historyId" type="INT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="operation" type="VARCHAR(7)">
                <constraints nullable="false"/>
            </column>
            <column name="operationTime" type="TIMESTAMP" defaultValueComputed="CURRENT_TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="id" type="INT"/>
            <column name="applicationUser" type="INT"/>
            <column name="deviceId" type="VARCHAR(255)"/>
            <column name="lastModifiedBy" type="INT"/>
        </createTable>
        <rollback>
            <dropTable tableName="DeviceHistory"/>
            <dropTable tableName="FriendHistory"/>
            <dropTable tableName="DocumentHistory"/>
            <dropTable tableName="ApplicationUserHistory"/>
            <dropTable tableName="UniversityHistory"/>
        </rollback>
    </changeSet>
    <changeSet id="202108141343" author="Szczepaniak-M" dbms="mssql">
        <comment>Adding triggers to fill history tables</comment>
        <sql endDelimiter="GO">
            -- UniversityHistory
            CREATE TRIGGER universityHistoryAfterInsertTrigger
                ON University
                AFTER INSERT AS
                INSERT INTO UniversityHistory(operation, id, name, address, address2, zipcode,
                                              city, country, description, lastModifiedBy)
                SELECT 'insert', i.*
                FROM inserted i;
            GO

            CREATE TRIGGER universityHistoryAfterUpdateTrigger
                ON University
                AFTER UPDATE AS
                INSERT INTO UniversityHistory(operation, id, name, address, address2, zipcode,
                                              city, country, description, lastModifiedBy)
                SELECT 'update', i.*
                FROM inserted i;
            GO

            CREATE TRIGGER universityHistoryAfterDeleteTrigger
                ON University
                AFTER DELETE AS
                INSERT INTO UniversityHistory(operation, id, name, address, address2, zipcode,
                                              city, country, description, lastModifiedBy)
                SELECT 'delete', d.*
                FROM deleted d;
            GO

            -- DocumentHistory
            CREATE TRIGGER documentHistoryAfterInsertTrigger
                ON Document
                AFTER INSERT AS
                INSERT INTO DocumentHistory(operation, id, name, description,
                                            path, university, lastModifiedBy)
                SELECT 'insert', i.*
                FROM inserted i;
            GO

            CREATE TRIGGER documentHistoryAfterUpdateTrigger
                ON Document
                AFTER UPDATE AS
                INSERT INTO DocumentHistory(operation, id, name, description,
                                            path, university, lastModifiedBy)
                SELECT 'update', i.*
                FROM inserted i;
            GO

            CREATE TRIGGER documentHistoryAfterDeleteTrigger
                ON Document
                AFTER DELETE AS
                INSERT INTO DocumentHistory(operation, id, name, description,
                                            path, university, lastModifiedBy)
                SELECT 'delete', d.*
                FROM deleted d;
            GO

            -- ApplicationUserHistory
            CREATE TRIGGER applicationUserHistoryAfterInsertTrigger
                ON ApplicationUser
                AFTER INSERT AS
                INSERT INTO ApplicationUserHistory(operation, id, type, firstName, lastName, email, password,
                                                   facebookUrl, whatsUpUrl, instagramUsername, university,
                                                   lastModifiedBy)
                SELECT 'insert', i.*
                FROM inserted i;
            GO

            CREATE TRIGGER applicationUserHistoryAfterUpdateTrigger
                ON ApplicationUser
                AFTER UPDATE AS
                INSERT INTO ApplicationUserHistory(operation, id, type, firstName, lastName, email, password,
                                                   facebookUrl, whatsUpUrl, instagramUsername, university,
                                                   lastModifiedBy)
                SELECT 'update', i.*
                FROM inserted i;
            GO

            CREATE TRIGGER applicationUserHistoryAfterDeleteTrigger
                ON ApplicationUser
                AFTER DELETE AS
                INSERT INTO ApplicationUserHistory(operation, id, type, firstName, lastName, email, password,
                                                   facebookUrl, whatsUpUrl, instagramUsername, university,
                                                   lastModifiedBy)
                SELECT 'delete', d.*
                FROM deleted d;
            GO

            -- DeviceHistory
            CREATE TRIGGER deviceHistoryAfterInsertTrigger
                ON Device
                AFTER INSERT AS
                INSERT INTO DeviceHistory(operation, id, applicationUser,
                                          deviceId, lastModifiedBy)
                SELECT 'insert', i.*
                FROM inserted i;
            GO

            CREATE TRIGGER deviceHistoryAfterUpdateTrigger
                ON Device
                AFTER UPDATE AS
                INSERT INTO DeviceHistory(operation, id, applicationUser,
                                          deviceId, lastModifiedBy)
                SELECT 'update', i.*
                FROM inserted i;
            GO

            CREATE TRIGGER deviceHistoryAfterDeleteTrigger
                ON Device
                AFTER DELETE AS
                INSERT INTO DeviceHistory(operation, id, applicationUser,
                                          deviceId, lastModifiedBy)
                SELECT 'delete', d.*
                FROM deleted d;
            GO

            --  FriendHistory
            CREATE TRIGGER friendHistoryAfterInsertTrigger
                ON Friend
                AFTER INSERT AS
                INSERT INTO FriendHistory(operation, id, applicationUser, friend, status, lastModifiedBy)
                SELECT 'insert', i.*
                FROM inserted i;
            GO

            CREATE TRIGGER friendHistoryAfterUpdateTrigger
                ON Friend
                AFTER UPDATE AS
                INSERT INTO FriendHistory(operation, id, applicationUser, friend, status, lastModifiedBy)
                SELECT 'update', i.*
                FROM inserted i;
            GO

            CREATE TRIGGER friendHistoryAfterDeleteTrigger
                ON Friend
                AFTER DELETE AS
                INSERT INTO FriendHistory(operation, id, applicationUser, friend, status, lastModifiedBy)
                SELECT 'delete', d.*
                FROM deleted d;
            GO
        </sql>
        <rollback>
            <sql>
                DROP TRIGGER IF EXISTS universityHistoryAfterInsertTrigger;
                DROP TRIGGER IF EXISTS universityHistoryAfterUpdateTrigger;
                DROP TRIGGER IF EXISTS universityHistoryAfterDeleteTrigger;

                DROP TRIGGER IF EXISTS documentHistoryAfterInsertTrigger;
                DROP TRIGGER IF EXISTS documentHistoryAfterUpdateTrigger;
                DROP TRIGGER IF EXISTS documentHistoryAfterDeleteTrigger;

                DROP TRIGGER IF EXISTS applicationUserHistoryAfterInsertTrigger;
                DROP TRIGGER IF EXISTS applicationUserHistoryAfterUpdateTrigger;
                DROP TRIGGER IF EXISTS applicationUserHistoryAfterDeleteTrigger;

                DROP TRIGGER IF EXISTS deviceHistoryAfterInsertTrigger;
                DROP TRIGGER IF EXISTS deviceHistoryAfterUpdateTrigger;
                DROP TRIGGER IF EXISTS deviceHistoryAfterDeleteTrigger;

                DROP TRIGGER IF EXISTS friendHistoryAfterInsertTrigger;
                DROP TRIGGER IF EXISTS friendHistoryAfterUpdateTrigger;
                DROP TRIGGER IF EXISTS friendHistoryAfterDeleteTrigger;
                GO
            </sql>
        </rollback>
    </changeSet>
</databaseChangeLog>
